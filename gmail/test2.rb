require 'google/apis/gmail_v1'
require 'googleauth'
require 'googleauth/stores/file_token_store'
require 'fileutils'
require 'mail'

OOB_URI = 'urn:ietf:wg:oauth:2.0:oob'.freeze
APPLICATION_NAME = 'Gmail API Ruby Quickstart'.freeze
CLIENT_SECRETS_PATH = 'client_secret.json'.freeze
CREDENTIALS_PATH = 'token.yaml'.freeze
SCOPE = Google::Apis::GmailV1::AUTH_GMAIL_SEND

def authorize
  client_id = Google::Auth::ClientId.from_file(CLIENT_SECRETS_PATH)
  token_store = Google::Auth::Stores::FileTokenStore.new(file: CREDENTIALS_PATH)
  authorizer = Google::Auth::UserAuthorizer.new(client_id, SCOPE, token_store)
  user_id = 'default'
  credentials = authorizer.get_credentials(user_id)

  if credentials.nil?
    code = '4/AAAX-kH6JfnNn0WMqAwMRlYf4j6UaHLZlgdVTkfqDbQwqEpT1-TRJr0'
    credentials = authorizer.get_and_store_credentials_from_code(
      user_id: user_id, code: code, base_url: OOB_URI
    )
  end

  credentials
end

service = Google::Apis::GmailV1::GmailService.new
service.client_options.application_name = APPLICATION_NAME
service.authorization = authorize

puts 'send_message START'
# options = {
#   :from => 'WTS System<system@orchidwine.com.au>',
#   :to => 'wuyue@techjumper.com',
#   :subject => 'Test Subject',
#   # :body => 'Test Mail Content<br/>message 2.'
# }

html = "<!DOCTYPE html>\n<html lang=\"zh\">\n  <head>\n    <meta charset=\"utf-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <title>澳麒酒业 管理后台</title>\n    <link rel=\"icon\" type=\"image/png\" href=\"/assets/logo-f1eb2b120f8f87fccd2c72104399693115d738c35638740b97ac83d1d7eede6f.png\" />\n    <style type=\"text/css\">\n    body {\n    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;\n    font-size: 13px;\n    font-weight: normal;\n    font-variant: normal;\n    color: #7a878e;\n    -moz-osx-font-smoothing: grayscale;\n    -webkit-font-smoothing: antialiased !important;\n    background-color: #eae8e3;\n    margin: 0;\n    }\n    \n    h5{\n    color: #4d627b;\n    font-size: 14px;\n    margin-top: 10px;\n    margin-bottom: 10px;\n    line-height: 1.1;\n    -webkit-margin-before: 1.67em;\n    -webkit-margin-after: 1.67em;\n    -webkit-margin-start: 0px;\n    -webkit-margin-end: 0px;\n    }\n    #page-content {\n    width: 96%;\n    padding: 20px 2% 0 2%;\n    position: relative;\n    float: left;\n    margin-top: -160px;\n    }\n    .row {\n    margin: 0 -10px;\n    float: left;\n    }\n    [class^=\"col-\"]:not(.pad-no) {\n    padding-left: 10px;\n    padding-right: 10px;\n    }\n    .panel {\n    border-radius: 3px;\n    border: 0;\n    box-shadow: none !important;\n    margin-bottom: 20px;\n    background-color: #fff;\n    }\n    .panel .panel-bg-cover {\n    max-height: 180px;\n    overflow: hidden;\n    }\n    .panel .panel-bg-cover img {\n    min-width: 100%;\n    min-height: 100%;\n    background-size: cover;\n    }\n    .panel.remove {\n    opacity: 0;\n    transition: opacity, 0.5s;\n    }\n    .panel .alert {\n    border-radius: 0;\n    }\n    .panel.panel-bg-img {\n    position: relative;\n    }\n    .panel .panel-bg-wrap {\n    overflow: hidden;\n    position: absolute;\n    top: 0;\n    left: 0;\n    bottom: 0;\n    right: 0;\n    }\n    .panel .panel-bg-wrap > img {\n    position: absolute;\n    top: 0;\n    left: 0;\n    }\n    .panel .panel-bg-wrap + .panel-body {\n    position: relative;\n    }\n    .panel-media {\n    box-shadow: 0 -50px 20px -10px rgba(0, 0, 0, 0.2);\n    padding: 10px 15px 15px 140px;\n    position: relative;\n    }\n    .panel-media-img {\n    position: absolute;\n    width: 96px;\n    height: 96px;\n    left: 20px;\n    top: -48px;\n    }\n    .panel-media-heading {\n    color: #fff;\n    position: absolute;\n    top: -2.7em;\n    }\n    .panel .panel-heading,\n    .panel > :first-child {\n    border-top-left-radius: 2px;\n    border-top-right-radius: 2px;\n    }\n    .panel .panel-footer,\n    .panel > :last-child {\n    border-bottom-left-radius: 2px;\n    border-bottom-right-radius: 2px;\n    }\n    .panel-body-full {\n    margin-left: -20px;\n    margin-right: -20px;\n    }\n    .panel-body {\n    padding: 15px 20px 25px;\n    }\n    .panel-trans {\n    border-color: transparent;\n    box-shadow: none;\n    background-color: transparent;\n    }\n    .panel-heading {\n    position: relative;\n    height: 42px;\n    padding: 0;\n    color: #4d627b;\n    }\n    .panel-heading .btn {\n    box-shadow: none !important;\n    }\n    .panel-title {\n    font-weight: normal;\n    padding: 0 20px 0 20px;\n    font-size: 1.15em;\n    line-height: 42px;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    }\n    .panel-default.panel-colorful {\n    background-color: #e6eced;\n    color: #7a878e;\n    }\n    .panel-default .panel-heading {\n    background-color: #e6eced;\n    border-color: #f5f7f8;\n    }\n    .panel-footer {\n    background-color: #fdfdfe;\n    color: #7a878e;\n    border-color: rgba(0, 0, 0, 0.02);\n    position: relative;\n    }\n    /*======================================*/\n    table {\n    border-spacing: 0;\n    border-collapse: collapse;\n    width: 100%\n    }\n    #container,\n    #container #boxed {\n    float: left;\n    width: 100%;\n    }\n    #content-container:before {\n    content: '';\n    display: block;\n    height: 165px;\n    width: 100%;\n    position: relative;\n    float: left;\n    background-color: #795548;\n    z-index: 0;\n    }\n    #container .table th {\n    text-align: left;\n    font-size: 1.05em;\n    font-weight: 600;\n    border-bottom: 1px solid rgba(0, 0, 0, 0.07);\n    color: #4d627b;\n    }\n    #container .table td {\n    border-top: 1px solid rgba(0, 0, 0, 0.07);\n    }\n    #container .table.table-vcenter th,\n    #container .table.table-vcenter td {\n    vertical-align: middle;\n    }\n    #container .table .min-width {\n    width: 1%;\n    white-space: nowrap;\n    padding-left: 15px !important;\n    padding-right: 15px !important;\n    }\n    #container .table-trans tr,\n    #container .table-trans td,\n    #container .table-trans th {\n    background-color: transparent !important;\n    border-color: transparent !important;\n    }\n    #container .table-bordered,\n    #container .table-bordered td,\n    #container .table-bordered th {\n    border-color: rgba(0, 0, 0, 0.07);\n    }\n    #container .table-striped > tbody > tr:nth-child(2n+1) {\n    background-color: rgba(0, 0, 0, 0.015);\n    }\n    #container .table-hover > tbody > tr:hover {\n    background-color: rgba(0, 0, 0, 0.015);\n    }\n    .table-bordered {\n    border: 1px solid #ddd;\n    }\n    .table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {\n    padding: 8px;\n    line-height: 1.42857143;\n    vertical-align: top;\n    border-top: 1px solid #ddd;\n    }\n    .table-bordered>tbody>tr>td, .table-bordered>tbody>tr>th, .table-bordered>tfoot>tr>td, .table-bordered>tfoot>tr>th, .table-bordered>thead>tr>td, .table-bordered>thead>tr>th {\n    border: 1px solid #ddd;\n    }\n    #container .table td {\n    border-top: 1px solid rgba(0, 0, 0, 0.07);\n    }\n    .col-sm-1, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-sm-10, .col-sm-11, .col-sm-12 {\n    float: left;\n    }\n    .col-sm-12 {\n    width: 98%;\n    }\n    .col-sm-11 {\n    width: 91.66666667%;\n    }\n    .col-sm-10 {\n    width: 83.33333333%;\n    }\n    .col-sm-9 {\n    width: 75%;\n    }\n    .col-sm-8 {\n    width: 66.66666667%;\n    }\n    .col-sm-7 {\n    width: 58.33333333%;\n    }\n    .col-sm-6 {\n    width: 50%;\n    }\n    .col-sm-5 {\n    width: 41.66666667%;\n    }\n    .col-sm-4 {\n    width: 33.33333333%;\n    }\n    .col-sm-3 {\n    width: 25%;\n    }\n    .col-sm-2 {\n    width: 16.66666667%;\n    }\n    .col-sm-1 {\n    width: 8.33333333%;\n    }\n    #footer {\n    background-color: #f6f8fa;\n    color: #7a878e;\n    position: relative;\n    padding-top: 10px;\n    bottom: 0;\n    z-index: 2;\n    left: 0;\n    right: 0;\n    height: 20px;\n    text-align: center;\n    float: left;\n    width: 100%;\n    overflow: hidden;\n    }\n    p {\n    margin: 0 0 10px;\n}\n    </style>\n  </head>\n  <body>\n    <div id=\"container\">\n      <div class=\"boxed\">\n        <div id=\"content-container\">\n          <div id=\"page-content\">\n  <div class=\"row\">\n    <div class=\"col-sm-12\">\n      <div class=\"panel\">\n        <div class=\"panel-body\">\n          <p>订单更新：<br/>\n          admin 更新了订单。</p>\n          <hr/>\n          <h5>订单 「PO-989」 详情</h5>\n          <table class=\"table table-bordered\">\n            <tbody>\n              <tr>\n                <td width=\"10%\"><b>订单号码</b></td>\n                <td width=\"40%\"><b>PO-989</b></td>\n                <td width=\"10%\"><b>交付方式</b></td>\n                <td width=\"40%\"><b>EXW（澳洲境内，卖方指定仓库提货，澳元结算）</b></td>\n              </tr>\n              <tr>\n                <td><b>客户信息</b></td>\n                <td colspan=\"3\"><b>刘新华</b></td>\n              </tr>\n              <tr>\n                <td><b>公司名称</b></td>\n                <td colspan=\"3\"><b>青岛瑞丰贸易有限公司</b></td>\n              </tr>\n            </tbody>\n          </table>\n          <h5>产品清单</h5>\n          <table class=\"table table-bordered\">\n            <thead>\n              <tr>\n                <th width=\"5%\">序号</th>\n                <th width=\"40%\">产品明细</th>\n                <th width=\"35%\">包装</th>\n                <th width=\"10%\">数量</th>\n                <th width=\"10%\">产品单价</th>\n              </tr>\n            </thead>\n            <tbody>\n              <tr>\n                <td>1</td>\n                <td>\n                  编号：1803 - BBPW/2017/阿德莱德山谷/小维多<br/>\n                  品牌：<br/>\n                  特殊要求：\n                </td>\n                <td><p class=\"text-primary\">使用标准包材配置。</p>瓶型：028C<br/>物料要求：<br/>酒帽：C（封蜡WAX）<br/>酒帽颜色：Black_Gold<br/>酒塞：B（没有木塞-螺旋盖）<br/>酒塞印刷：有<br/>分隔板：HH-12<br/>包装方式：6x750ml<br/>纸箱：6支装Print<br/>前标：，后标：，中文背标：无<br/></td>\n                <td>8,000</td>\n                <td>$ 6.0</td>\n              </tr>\n              <tr>\n                <td>2</td>\n                <td>\n                  编号：1804 - PJW/2017/南澳大利亚/赤霞珠<br/>\n                  品牌：<br/>\n                  特殊要求：\n                </td>\n                <td><p class=\"text-primary\">使用标准包材配置。</p>瓶型：028C<br/>物料要求：<br/>酒帽：C（锡）<br/>酒帽颜色：空值<br/>酒塞：B（没有木塞-螺旋盖）<br/>酒塞印刷：无<br/>分隔板：FH-12<br/>包装方式：6x750ml<br/>纸箱：6支装WBox<br/>前标：，后标：，中文背标：无<br/></td>\n                <td>5,000</td>\n                <td>$ 6.0</td>\n              </tr>\n            </tbody>\n          </table>\n          <h5>订单报价</h5>\n          <table class=\"table table-bordered\">\n            <thead>\n              <tr>\n                <th width=\"55%\">产品明细</th>\n                <th width=\"15%\">产品总价</th>\n                <th width=\"15%\">附加费用</th>\n                <th width=\"15%\">合计</th>\n              </tr>\n            </thead>\n            <tbody>\n              <tr>\n                <td>1803 - BBPW/2017/阿德莱德山谷/小维多</td>\n                <td>$ 48,000.0</td>\n                <td>/</td>\n                <td>$ 48,000.0</td>\n              </tr>\n              <tr>\n                <td>1804 - PJW/2017/南澳大利亚/赤霞珠</td>\n                <td>$ 30,000.0</td>\n                <td>/</td>\n                <td>$ 30,000.0</td>\n              </tr>\n              <tr>\n                <td colspan=\"3\" class=\"text-right\">产品总价</td>\n                <td>$ 288,000.0</td>\n              </tr>\n            </tbody>\n          </table>\n          <h5>发货信息</h5>\n          <table class=\"table table-bordered\">\n            <tbody>\n              <tr>\n                <td width=\"15%\"><b>起运港口</b></td>\n                <td width=\"20%\">阿德莱德</td>\n                <td width=\"15%\"><b>目的港口</b></td>\n                <td width=\"20%\">天津</td>\n                <td width=\"15%\"><b>海运保险</b></td>\n                <td width=\"15%\">是</td>\n              </tr>\n              <tr>\n                <td width=\"15%\"><b>海运承运方</b></td>\n                <td width=\"55%\" colspan=\"3\">\n                  <b>澳麒指定（Orchid Wine Arrange）</b><br/>\n                  海运公司名称：<br/>\n                  联系人：<br/>\n                  电话：<br/>\n                  电子邮箱：\n                </td>\n                <td width=\"15%\"><b>隔热棉要求</b></td>\n                <td width=\"15%\">是</td>\n              </tr>\n              <tr>\n                <td width=\"15%\"><b>出口方</b></td>\n                <td width=\"35%\">\n                  公司名称：Orchid Wine Estate Pty Ltd<br/>\n                  公司地址：208 gouger street，Adelaide，SA 5000<br/>\n                  联系人：Jonathon Li<br/>\n                  电话：+61 8 8410 4635<br/>\n                  邮件：info@orchidwine.com.au\n                </td>\n                <td width=\"15%\"><b>接货方</b></td>\n                <td width=\"35%\"colspan=\"3\">\n                  公司名称：<br/>\n                  公司地址：<br/>\n                  联系人：<br/>\n                  电话：<br/>\n                  邮件：\n                </td>\n              </tr>\n              <tr>\n                <td width=\"15%\"><b>卖方</b></td>\n                <td width=\"35%\">\n                  公司名称：Orchid Wine Estate Pty Ltd<br/>\n                  公司地址：208 gouger street，Adelaide，SA 5000<br/>\n                  联系人：Jonathon Li<br/>\n                  电话：+61 8 8410 4635<br/>\n                  邮件：info@orchidwine.com.au\n                </td>\n                <td width=\"15%\"><b>买方</b></td>\n                <td width=\"35%\" colspan=\"3\">\n                  公司名称：<br/>\n                  公司地址：<br/>\n                  联系人：<br/>\n                  电话：<br/>\n                  邮件：\n                </td>\n              </tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n        </div>\n        \n        <footer id=\"footer\">\n          <div class=\"hide-fixed pull-center pad-rgt\">\n            &#0169; 2018 Orchid Wine.\n          </div>\n        </footer>\n      </div>\n    </div>\n  </body>\n</html>"

message = Mail.new do
  from     'system@orchidwine.com.au'
  to       'wuyue@techjumper.com'
  subject  'Test Subject'

  html_part do
    content_type 'text/html; charset=UTF-8'
    body html
  end
end


service.send_user_message('me',
                          upload_source: StringIO.new(message.to_s),
                          content_type: 'message/rfc822')
puts 'send_message END'
